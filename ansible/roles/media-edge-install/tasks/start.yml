- name: Start origin
  block:
    - name: Stop origin
      shell: docker compose down
      args:
        chdir: /root/containers
    - name: Start origin
      shell: docker compose up -d
      args:
          chdir: /root/containers

    - name: Wait for Kibana to be ready
      uri:
        url: http://localhost:5601/api/status
        status_code: 200
      register: kibana_status
      until: kibana_status.status == 200
      retries: 10
      delay: 10

    - name: Load kibana dashboard
      command:
        cmd: 'curl -X POST http://localhost:5601/api/saved_objects/_import?createNewCopies=true -H "kbn-xsrf: true" --form file=@dashboard.ndjson'
        chdir: /root/containers/
  when: inventory_hostname in groups["origin"]

- name: Start edge
  block:
    - name: Stop edge
      shell: docker compose down
      args:
        chdir: /root/containers
    - name: Start edge
      shell: docker compose up -d
      args:
        chdir: /root/containers
    - name: wait until caddy is running
      uri:
          url: http://localhost:80
          status_code: 200
      register: caddy_status
      until: caddy_status.status == 200
      retries: 10
      delay: 10

    - name: Change caddyLogs folder permissions
      shell: chmod 755 -R /root/containers/caddyLogs
  when: inventory_hostname in groups["edge"]