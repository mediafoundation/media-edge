{
    order bandwidth before header
    #auto_https disable_redirects
    #on_demand_tls {
    #    ask http://{{ origin_ips[0] }}:7878/domains
    #}
    auto_https off
    log {
        format elastic
        output file /var/log/caddy/admin_access.log
    }
}

https:// {
    header Server "MediaEdge v{{ media_edge_version }} | https://media.network"
    reverse_proxy http://varnish-edge:8080 {
        @hasBandwidthLimit header X-Bandwidth-Limit Yes
        handle_response @hasBandwidthLimit {
            bandwidth {
                limit 50000
            }
            reverse_proxy http://varnish-edge:8080
        }
    }
    tls {
        on_demand
    }
    log {
        format elastic
        output file /var/log/caddy/access.log
    }
}

http:// {
    header Server "MediaEdge v{{ media_edge_version }} | https://media.network"
    handle /.well-known/acme-challenge/* {
        reverse_proxy http://{{ origin_ips[0] }}:7878
    }
    reverse_proxy http://varnish-edge:8080 {
        @hasBandwidthLimit header X-Bandwidth-Limit Yes
        handle_response @hasBandwidthLimit {
            bandwidth {
               limit 50000
            }
            reverse_proxy http://varnish-edge:8080
        }
    }
    log {
        format elastic
        output file /var/log/caddy/access.log
    }
}